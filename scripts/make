#!/bin/sh

## hyphop ##

#= make khadas uboot script wrapper

PR=$(dirname $0)
RP=$(realpath $PR)

cd "$PR" || exit 1

MSG(){
    echo "[i] $@"
}

info_msg(){
    echo "[i] $@"
}

CMD(){
    echo "[#] $@">&2
    "$@"
}

FAIL(){
    echo "[e] $@">&2
    exit 1
}

PATCHING(){
[ -e "$BS/.ready.log" ] || {

for P in $PKD/patches/$PKG_VERSION/*.patch; do
    [ -f "$P" ] && {
	PN=$(basename $P)
	echo "[i] PATCH $PN"
	patch -p1 -d"$BS" < "$P" || FAIL
    }
done

echo READY > "$BS/.ready.log"

}
}

BUILD_PKG(){
PKG="$PKD/package.mk"

echo "[i] build $PKG"

make_host(){
.
}

make_target(){
.
}

make_target_deps(){
.
}

post_make_target(){
.
}

. $PKG

./download \
    "$PKG_URL" \
    "$PKG_SOURCE_NAME" \
    "$DOWNLOADS" || FAIL download uboot source

BS="$BUILD/$PKG_SOURCE_DIR"

[ -s "$BS" ] || { echo "[i] EXTRACT ... $BS"
CMD tar -xf"$(realpath "$DOWNLOADS/$PKG_SOURCE_NAME")" -C"$BUILD" --one-top-level="$PKG_SOURCE_DIR"
CMD ln -sf "$PKG_SOURCE_DIR" "$BUILD/$PKG_NAME"
}

PATCHING

cd $BS

make_host || echo "[w] make_host $PKD .. no ..."

[ "$1" = "u-boot-mainline" ] || \
make_target || echo "[w] make_target $PKD  ... no ..."

cd -

}

#################################
## BEGIN
##

echo "[i] make khadas uboot"

. ./build.conf

[ -d $DOWNLOADS ] || \
    mkdir -p $DOWNLOADS

[ -d "$BUILD" ] || \
    mkdir -p "$BUILD"

./download \
    $DLBASE/$GCCZ \
    $GCCZ \
    $DOWNLOADS || FAIL download gcc

[ -s "$BUILD/$GCC" ] || { echo "[i] EXTRACT ... $GCC"
tar -xf"$(realpath "$DOWNLOADS/$GCCZ")"        -C"$BUILD" --one-top-level="$GCC" || FAIL 
ln -sf $GCC $BUILD/gcc
}

[ "$ATF_BUILD" ] && {
./download \
    $DLBASE/$GCCZN \
    $GCCZN \
    $DOWNLOADS || FAIL download gcc

[ -s "$BUILD/$GCCN" ] || { echo "[i] EXTRACT ... $GCCN"
tar -xf"$(realpath "$DOWNLOADS/$GCCZN")"        -C"$BUILD" --one-top-level="$GCCN" || FAIL 
ln -sf $GCCN $BUILD/gcc-none-eabi
}
}

./download \
    $DLBASE/$FIPZ \
    $FIPZ \
    $DOWNLOADS || FAIL download fip

[ -s "$BUILD/$FIP" ] || { echo "[i] EXTRACT ... $FIP"
tar -xf"$(realpath "$DOWNLOADS/$FIPZ")"        -C"$BUILD" --one-top-level="$FIP" || FAIL
}

[ "$1" = re ] && {
    MSG REBUILD UBOOT
    rm -rf $BUILD/u-boot-*
    shift
}

export UBOOT_COMPILER_PATH=$(realpath "$BUILD/gcc")/bin
export PATH="$EXTRA_PATH:$UBOOT_COMPILER_PATH:$PATH"
export ARCH=arm64
export CROSS_COMPILE=aarch64-none-linux-gnu-
export UBOOT_COMPILER=$CROSS_COMPILE

${CROSS_COMPILE}gcc --version || FAIL gcc

#arm-none-eabi-gcc --version || FAIL $PATH gcc-none-eabi

PKGS=u-boot-mainline

[ "$ATF_BUILD" ] && PKGS="arm-trusted-firmware $PKGS"

for P in $PKGS; do
    PKD=../packages/$P
    BUILD_PKG $P
done

[ "$DEF_CONFIG" ] || DEF_CONFIG=$DEF_CONFIG2

case $DEF_CONFIG in
    *edge*|*rk*)
    VENDOR=Rockchip
    ;;
    *)
    VENDOR=Amlogic
    ;;
esac

export UBOOT_DEFCONFIG=$DEF_CONFIG

echo "[i] VENDOR $VENDOR ($DEF_CONFIG)"

PKGS_DIR=$(realpath "$PKGS_DIR0")

MANUAL=1

[ "$1" = re ] && {
    MSG REBUILD UBOOT
    rm -rf $BUILD/u-boot-*
    shift
}

[ "$MANUAL" ] && {
echo "[i] manual build"

cd "$BS"
UBOOT_DIR="$PWD"
make_target_deps
cd -

[ -s "$BS/.config" ] || make -C"$BS" $DEF_CONFIG
make -C"$BS" $PJ $@ || FAIL make fail
}

(
cd "$BS"
UBOOT_DIR="$PWD"
[ "$MANUAL" ] || \
make_target
post_make_target
)

cp $BS/u-boot.spi* /tmp
cp $BS/u-boot.mmc* /tmp

